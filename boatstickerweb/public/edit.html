<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Your Boat Design</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f5f5f5;
    }

    .editor-wrapper {
      display: flex;
      height: 100vh;
    }

    .toolbox {
      width: 250px;
      background: #212121;
      color: white;
      padding: 20px;
      box-sizing: border-box;
    }

    .text-box:focus, .text-box.selected {
    outline: 2px solid #03a9f4;
    box-shadow: 0 0 8px #03a9f4;
    cursor: move;
  }


      /* Rotation handle */
  .rotate-handle {
    position: absolute;
    width: 16px;
    height: 16px;
    background: #03a9f4;
    border-radius: 50%;
    right: -10px;
    top: -10px;
    cursor: grab;
  }
    
    
    .toolbox h2 {
      font-size: 18px;
      margin-bottom: 10px;
    }

    .toolbox label {
      display: block;
      margin-top: 10px;
      font-size: 14px;
    }

    .toolbox input,
    .toolbox select,
    .toolbox button {
      width: 100%;
      margin-top: 4px;
      padding: 8px;
      box-sizing: border-box;
      border-radius: 4px;
      border: none;
    }

    .toolbox button {
      background: #03a9f4;
      color: #fff;
      margin-top: 15px;
      cursor: pointer;
    }

    .toolbox button:hover {
      background: #0288d1;
    }

    .editor-canvas {
      flex-grow: 1;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .editor-canvas img {
      max-width: 90%;
      max-height: 90%;
      outline: 4px solid #ccc;
      border-radius: 6px;
    }

    .text-box {
      position: absolute;
      padding: 4px 8px;
      cursor: move;
      resize: both;
      overflow: hidden;
      border: 1px dashed #666;
      background: rgba(255, 255, 255, 0.6);
    }

    .resizable {
      resize: both;
      overflow: auto;
    }

    .bottom-buttons {
      position: absolute;
      bottom: 10px;
      left: 10px;
    }

    .bottom-buttons button {
      margin-right: 10px;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      background: #03a9f4;
      color: #fff;
      cursor: pointer;
    }

    .bottom-buttons button:hover {
      background: #0288d1;
    }
  </style>
</head>
<body>

<div class="editor-wrapper">
  <!-- Left Panel / Toolbox -->
  <div class="toolbox">
    <h2>Tools</h2>
    <label for="textInput">Add Text:</label>
    <input type="text" id="textInput" placeholder="Enter your text" />

    <label for="fontSelect">Font:</label>
    <select id="fontSelect">
      <option value="Arial">Arial</option>
      <option value="Comic Sans MS">Comic Sans</option>
      <option value="Impact">Impact</option>
      <option value="Georgia">Georgia</option>
      <option value="Courier New">Courier</option>
    </select>

    <label for="fontSize">Font Size:</label>
    <input type="number" id="fontSize" value="24" />

    <label for="textColor">Text Color:</label>
    <input type="color" id="textColor" value="#000000" />

    <button onclick="addText()">Add Text</button>
  </div>

  <!-- Right Side / Canvas -->
  <div class="editor-canvas" id="canvas">
    <img id="preview" src="" alt="AI-generated boat image" />
    <div class="bottom-buttons">
      <button onclick="alert('Sticker purchase flow here')">Buy as Sticker</button>
      <button onclick="alert('Shirt purchase flow here')">Buy as Shirt</button>
      <button onclick="alert('Mug purchase flow here')">Buy as Mug</button>
    </div>
  </div>
</div>
<script>
// 1. Image load from URL param (keep this)
const urlParams = new URLSearchParams(window.location.search);
const img = urlParams.get("img");

if (!img) {
  document.body.innerHTML = "<p style='text-align:center;'>Image not found. Please go back and generate an image first.</p>";
} else {
  document.getElementById("preview").src = img;
}

// 2. New text adding / selecting / dragging / rotating code (replace your old addText and related logic)
let addingTextMode = false;
let selectedTextBox = null;

const canvas = document.getElementById("canvas");
const textInput = document.getElementById("textInput");
const fontSelect = document.getElementById("fontSelect");
const fontSize = document.getElementById("fontSize");
const textColor = document.getElementById("textColor");
const addTextBtn = document.querySelector("button[onclick='addText()']");

addTextBtn.onclick = () => {
  addingTextMode = true;
  canvas.style.cursor = "text";
  addTextBtn.disabled = true;
  textInput.value = ""; // Clear input for new text
};

canvas.onclick = (e) => {
  if (!addingTextMode) return;

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  // Create new editable text box
  const div = document.createElement("div");
  div.className = "text-box selected";
  div.contentEditable = true;
  div.innerText = textInput.value || "Edit me";
  div.style.fontFamily = fontSelect.value;
  div.style.fontSize = fontSize.value + "px";
  div.style.color = textColor.value;
  div.style.left = x + "px";
  div.style.top = y + "px";
  div.style.position = "absolute";
  div.style.userSelect = "text";
  div.style.transform = "rotate(0deg)";
  div.style.minWidth = "50px";
  div.style.minHeight = "24px";
  div.style.padding = "2px 5px";
  div.style.whiteSpace = "pre-wrap";

  canvas.appendChild(div);
  div.focus();

  addTextBtn.disabled = false;
  canvas.style.cursor = "default";
  addingTextMode = false;

  selectTextBox(div);
};

function selectTextBox(div) {
  // Deselect previous
  if (selectedTextBox && selectedTextBox !== div) {
    selectedTextBox.classList.remove("selected");
    removeRotateHandle(selectedTextBox);
  }
  selectedTextBox = div;
  selectedTextBox.classList.add("selected");
  addRotateHandle(selectedTextBox);
}

function deselectAll() {
  if (selectedTextBox) {
    selectedTextBox.classList.remove("selected");
    removeRotateHandle(selectedTextBox);
    selectedTextBox = null;
  }
}

function addRotateHandle(div) {
  const handle = document.createElement("div");
  handle.className = "rotate-handle";
  div.appendChild(handle);

  let startAngle = 0;
  let startX, startY;

  handle.onmousedown = (e) => {
    e.stopPropagation();
    e.preventDefault();

    const rect = div.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;

    startX = e.clientX;
    startY = e.clientY;
    startAngle = getRotationAngle(div);

    function onMouseMove(ev) {
      const dx = ev.clientX - centerX;
      const dy = ev.clientY - centerY;
      let angle = Math.atan2(dy, dx) * (180 / Math.PI);
      angle = angle < 0 ? 360 + angle : angle;

      let rotation = angle; // Or adjust relative to startAngle if needed
      div.style.transform = `rotate(${rotation}deg)`;
    }

    function onMouseUp() {
      document.removeEventListener("mousemove", onMouseMove);
      document.removeEventListener("mouseup", onMouseUp);
    }

    document.addEventListener("mousemove", onMouseMove);
    document.addEventListener("mouseup", onMouseUp);
  };
}

function removeRotateHandle(div) {
  const handle = div.querySelector(".rotate-handle");
  if (handle) div.removeChild(handle);
}

function getRotationAngle(el) {
  const st = window.getComputedStyle(el, null);
  const tr = st.getPropertyValue("transform");
  if (tr === "none") return 0;
  const values = tr.split('(')[1].split(')')[0].split(',');
  const a = values[0];
  const b = values[1];
  const angle = Math.round(Math.atan2(b, a) * (180/Math.PI));
  return angle < 0 ? angle + 360 : angle;
}

// Make selected text draggable
document.addEventListener("mousedown", function(e) {
  if (!selectedTextBox) return;

  if (!selectedTextBox.contains(e.target)) return;

  if (e.target.classList.contains("rotate-handle")) return; // skip rotate handle drag

  e.preventDefault();

  let shiftX = e.clientX - selectedTextBox.getBoundingClientRect().left;
  let shiftY = e.clientY - selectedTextBox.getBoundingClientRect().top;

  function moveAt(pageX, pageY) {
    selectedTextBox.style.left = pageX - shiftX + "px";
    selectedTextBox.style.top = pageY - shiftY + "px";
  }

  function onMouseMove(event) {
    moveAt(event.pageX, event.pageY);
  }

  document.addEventListener("mousemove", onMouseMove);

  document.addEventListener("mouseup", function onMouseUp() {
    document.removeEventListener("mousemove", onMouseMove);
    document.removeEventListener("mouseup", onMouseUp);
  });
});

// Select text box on click
canvas.addEventListener("click", (e) => {
  if (e.target.classList.contains("text-box")) {
    selectTextBox(e.target);
  } else if (!addingTextMode) {
    deselectAll();
  }
});

</script>
</body>
</html>

