<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Turn your boat into a custom sticker, shirt, or any print-on-demand item using AI." />
  <meta name="keywords" content="boat sticker, boat shirt, custom boat print, AI boat art, personalized boat merchandise" />
  <meta name="author" content="Boat2Merch" />
  <title>Boat2Merch ‚Äî Turn Your Boat into Stickers & Shirts</title>

  <!-- Favicon / App Icon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/images/icon.png?v=3">
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Local tweaks so buttons sit nicely under the text */
    .hero .lead-wrap { max-width: 560px; }
    .hero .controls { justify-content: flex-start; margin-top: 14px; margin-left: 4px; }
    .hero #statusArea { margin-top: 12px; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="container nav-row">
      <div class="brand">
        <img src="/images/icon.png" class="logo-img" alt="" width="24" height="24" />
        <span>Boat2Merch</span>
      </div>
      <nav class="topnav" aria-label="Primary">
        <a href="index.html" class="active">Home</a>
        <a href="how-it-works.html">How It Works</a>
        <a href="pricing.html">Pricing</a>
        <a href="examples.html">Examples</a>
        <a href="contact.html">Contact</a>
      </nav>

      <!-- Account pill (shows ‚ÄúSign in‚Äù or the user‚Äôs email) -->
      <div class="account-slot">
        <button id="signinBtn" class="btn btn-ghost small">Sign in</button>
        <div id="userPill" class="signed-in-pill hidden">
          <span id="userEmail"></span>
          <button id="signoutBtn" class="btn btn-ghost tiny">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero">
    <div class="container hero-inner">
      <!-- Left: copy + controls (buttons moved directly under text) -->
      <div class="lead-wrap">
        <h1 class="headline">Turn your boat photo into a clean, die-cut sticker ‚Äî instantly.</h1>
        <p class="subhead">Upload a photo. Our AI returns a crisp line-art with an optional white contour, ready for stickers, shirts, and more.</p>

        <!-- Hidden system file input -->
        <input type="file" id="boatUpload" accept="image/*" style="display:none" />

        <!-- Buttons now live directly under the text -->
        <div class="controls">
          <button class="btn btn-primary" id="btnImage">Generate an Image</button>
          <button class="btn btn-secondary" id="btnSticker">Generate a Sticker</button>
          <button class="btn btn-ghost" id="editBtn">Buy as a sticker</button>
        </div>

        <!-- Status -->
        <div id="statusArea" aria-live="polite"></div>

        <!-- Result -->
        <div id="resultPanel" class="card pad" style="margin-top:12px; display:none; position: relative;">
          <p class="muted" style="margin:0 0 8px;">Your AI-generated output:</p>
          <div class="result-wrap">
            <img id="resultImage" class="result-img" alt="AI generated boat drawing" />
            <!-- Sign-in gate overlay (only shown when not signed in) -->
            <div id="gate" class="gate hidden" role="dialog" aria-label="Sign in required">
              <div class="gate-box">
                <h3>Sign in to view & download</h3>
                <p class="muted">We‚Äôll email you a secure link ‚Äî no password needed.</p>
                <button id="gateSignIn" class="btn btn-primary">Continue</button>
                <small class="muted">No spam. One-click sign in.</small>
              </div>
            </div>
          </div>
          <div class="btn-row">
            <a id="downloadBtn" class="btn btn-ghost" download="boat-ai-design.png" aria-disabled="true">Download</a>
            <button id="buyBtn" class="btn btn-secondary" aria-disabled="true">Buy as a sticker</button>
          </div>
        </div>
      </div>

      <!-- Right: expanded explainer -->
      <aside class="card pad">
        <h2 style="margin:0 0 10px;">How it works</h2>
        <ol class="muted" style="margin:10px 0 0; padding-left:18px;">
          <li><strong>Pick your mode:</strong> <em>Generate an Image</em> gives you a clean black-and-white line drawing. <em>Generate a Sticker</em> adds a bold white contour for die-cut stickers.</li>
          <li><strong>Upload a clear photo:</strong> Side or 3/4 views work best. Keep the boat centered with minimal background clutter.</li>
          <li><strong>We process it:</strong> Our model cleans lines, simplifies shapes, and (for stickers) adds the white outline on a transparent background.</li>
          <li><strong>Download or order:</strong> Save the PNG/WebP, or jump straight to checkout for pro-quality die-cut stickers.</li>
          <li class="muted"><small>Tip: Higher-resolution photos = cleaner edges and fewer artifacts.</small></li>
        </ol>
      </aside>
    </div>
  </section>

  <!-- Features -->
  <section class="features">
    <div class="container">
      <div class="feature-grid">
        <div class="feature-card card pad">
          <h3>üé® Clean Line-Art</h3>
          <p class="muted">High-contrast look that prints beautifully on dark or light surfaces.</p>
        </div>
        <div class="feature-card card pad">
          <h3>üõç Print-Ready</h3>
          <p class="muted">Transparent background and (optional) white outline ‚Äî no extra editing needed.</p>
        </div>
        <div class="feature-card card pad">
          <h3>‚ö° Fast</h3>
          <p class="muted">Most results are ready in under two minutes. Grab it and go.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="cta">
    <div class="container">
      <h2 style="margin:0 0 10px;">Ready to try it?</h2>
      <p class="muted" style="margin:0 0 18px;">Choose your mode above and upload a photo.</p>
      <button class="btn btn-primary" onclick="document.getElementById('btnImage').click()">Get started</button>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="container">
      <p>&copy; 2025 Boat2Merch ¬∑ All rights reserved.</p>
    </div>
  </footer>

  <!-- Sign-in Modal (magic-link) -->
  <div id="authModal" class="auth-modal hidden" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <div class="auth-card">
      <button class="auth-close" id="authClose" aria-label="Close">√ó</button>
      <h2 id="authTitle" style="margin:0 0 8px;">Sign in</h2>
      <p class="muted" style="margin:0 0 14px;">We‚Äôll email you a secure link. No password needed.</p>
      <form id="authForm">
        <label for="authEmail" class="sr-only">Email</label>
        <input type="email" id="authEmail" placeholder="you@example.com" required />
        <button type="submit" class="btn btn-primary" id="authSubmit">Send magic link</button>
      </form>
      <div id="authNote" class="muted tiny" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- Tiny toast -->
  <div id="toast" class="toast hidden"></div>

  <!-- Scripts -->
  <script>
    const boatUpload = document.getElementById("boatUpload");
    const btnImage = document.getElementById("btnImage");
    const btnSticker = document.getElementById("btnSticker");
    const editBtn = document.getElementById("editBtn");
    const statusArea = document.getElementById("statusArea");
    const resultPanel = document.getElementById("resultPanel");
    const resultImage = document.getElementById("resultImage");
    const downloadBtn = document.getElementById("downloadBtn");
    const buyBtn = document.getElementById("buyBtn");
    const gate = document.getElementById("gate");
    const gateSignIn = document.getElementById("gateSignIn");

    // Auth widgets
    const signinBtn = document.getElementById("signinBtn");
    const userPill = document.getElementById("userPill");
    const userEmailEl = document.getElementById("userEmail");
    const signoutBtn = document.getElementById("signoutBtn");

    const authModal = document.getElementById("authModal");
    const authClose = document.getElementById("authClose");
    const authForm = document.getElementById("authForm");
    const authEmail = document.getElementById("authEmail");
    const authSubmit = document.getElementById("authSubmit");
    const authNote = document.getElementById("authNote");
    const toast = document.getElementById("toast");

    let currentMode = "image"; // "image" | "sticker"
    let isAuthed = false;

    // --------------- helpers ---------------
    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 2600);
    }
    function openAuth() {
      authModal.classList.remove("hidden");
      setTimeout(() => authEmail.focus(), 0);
    }
    function closeAuth() {
      authModal.classList.add("hidden");
      authForm.reset();
      authNote.textContent = "";
    }
    async function fetchJSON(url, opts) {
      const r = await fetch(url, opts);
      const t = await r.text();
      try { return { ok: r.ok, json: JSON.parse(t) }; }
      catch { return { ok: r.ok, json: t }; }
    }
    function setAuthedState(email) {
      isAuthed = !!email;
      if (isAuthed) {
        signinBtn.classList.add("hidden");
        userPill.classList.remove("hidden");
        userEmailEl.textContent = email;
        gate.classList.add("hidden");
        downloadBtn.removeAttribute("aria-disabled");
        buyBtn.removeAttribute("aria-disabled");
      } else {
        signinBtn.classList.remove("hidden");
        userPill.classList.add("hidden");
        userEmailEl.textContent = "";
      }
    }

    async function checkSession() {
      try {
        const { ok, json } = await fetchJSON("/auth/session");
        if (ok && json && json.user && json.user.email) {
          setAuthedState(json.user.email);
        } else {
          setAuthedState(null);
        }
      } catch {
        // If session endpoint doesn't exist yet, just hide the UI but keep app usable
        signinBtn.classList.add("hidden");
        userPill.classList.add("hidden");
      }
    }

    // --------------- Auth UI wiring ---------------
    signinBtn?.addEventListener("click", openAuth);
    gateSignIn?.addEventListener("click", openAuth);
    authClose?.addEventListener("click", closeAuth);
    authModal?.addEventListener("click", (e) => { if (e.target === authModal) closeAuth(); });

    authForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = authEmail.value.trim();
      if (!email) return;

      authSubmit.disabled = true;
      authSubmit.textContent = "Sending‚Ä¶";
      authNote.textContent = "";

      const { ok, json } = await fetchJSON("/auth/send-link", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });

      authSubmit.disabled = false;
      authSubmit.textContent = "Send magic link";

      if (ok) {
        authNote.textContent = "Check your email for the sign-in link.";
      } else {
        authNote.textContent = (json && json.error) ? json.error : "Could not send link right now.";
      }
    });

    signoutBtn?.addEventListener("click", async () => {
      const { ok } = await fetchJSON("/auth/signout", { method: "POST" });
      if (ok) {
        setAuthedState(null);
        showToast("Signed out");
      }
    });

    // --------------- Generate buttons ---------------
    btnImage.addEventListener("click", () => { currentMode = "image"; boatUpload.click(); });
    btnSticker.addEventListener("click", () => { currentMode = "sticker"; boatUpload.click(); });

    // Handle upload + polling
    boatUpload.addEventListener("change", async () => {
      if (boatUpload.files.length === 0) return;

      // Reset UI
      resultPanel.style.display = "none";
      editBtn.classList.remove("visible");
      statusArea.innerHTML = `
        <div class="loading-container">
          <div class="spinner" aria-hidden="true"></div>
          <div>Uploading and generating (${currentMode})‚Ä¶ This can take up to 2 minutes.</div>
        </div>
      `;

      const file = boatUpload.files[0];
      const formData = new FormData();
      formData.append("boatImage", file);
      formData.append("mode", currentMode);

      try {
        const uploadResp = await fetch("/generate-image", { method: "POST", body: formData });
        if (!uploadResp.ok) throw new Error("Upload failed");

        const { prediction } = await uploadResp.json();
        const predictionId = prediction?.id;
        if (!predictionId) throw new Error("No prediction ID returned");

        const pollInterval = 2000; // ms
        const maxAttempts = 30;
        let attempts = 0;

        async function poll() {
          attempts++;
          const statusResp = await fetch(`/prediction-status/${predictionId}`);
          const statusData = await statusResp.json();

          if (statusData.status === "succeeded" && statusData.output?.length) {
            const imageUrl = statusData.output[0];

            // Update UI
            statusArea.innerHTML = "";
            resultImage.src = imageUrl;
            resultPanel.style.display = "block";

            // Gate: if not signed in, blur + disable actions
            if (!isAuthed) {
              gate.classList.remove("hidden");
              downloadBtn.setAttribute("aria-disabled", "true");
              buyBtn.setAttribute("aria-disabled", "true");
              downloadBtn.removeAttribute("href");
            } else {
              gate.classList.add("hidden");
              downloadBtn.href = imageUrl;
              downloadBtn.removeAttribute("aria-disabled");
              buyBtn.removeAttribute("aria-disabled");
            }

            // CTA buttons
            editBtn.classList.add("visible");
            const goBuy = () => {
              if (!isAuthed) { openAuth(); return; }
              window.location.href = "buy.html?img=" + encodeURIComponent(imageUrl);
            };
            editBtn.onclick = goBuy;
            buyBtn.onclick = goBuy;

          } else if (statusData.status === "failed") {
            statusArea.innerHTML = `<div class="card pad" style="border-color:#733;">Generation failed. Please try a different photo.</div>`;
          } else {
            if (attempts < maxAttempts) {
              setTimeout(poll, pollInterval);
            } else {
              statusArea.innerHTML = `<div class="card pad" style="border-color:#735;">Generation timed out. Please try again later.</div>`;
            }
          }
        }

        poll();
      } catch (err) {
        console.error(err);
        statusArea.innerHTML = `<div class="card pad" style="border-color:#733;">Error: ${err.message}</div>`;
      } finally {
        boatUpload.value = "";
      }
    });

    // Kick off session check on load
    checkSession();

    // If you redirect back after magic link verify with ?login=ok
    if (new URLSearchParams(location.search).get("login") === "ok") {
      showToast("You're signed in!");
      // Clean the URL
      const url = new URL(location.href);
      url.searchParams.delete("login");
      history.replaceState({}, "", url);
      checkSession();
    }
  </script>
</body>
</html>
